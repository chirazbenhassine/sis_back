package com.projet.securite.filter;import com.auth0.jwt.JWT;import com.auth0.jwt.algorithms.Algorithm;import com.fasterxml.jackson.databind.ObjectMapper;import com.projet.securite.domain.dto.user.ResultDto;import com.projet.securite.domain.dto.user.TokensDto;import com.projet.securite.domain.dto.user.UserDto;import com.projet.securite.security.JWTUTIL;import com.projet.securite.service.UserImpl;import lombok.extern.slf4j.Slf4j;import org.springframework.security.authentication.AuthenticationManager;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;import org.springframework.security.core.Authentication;import org.springframework.security.core.AuthenticationException;import org.springframework.security.core.GrantedAuthority;import org.springframework.security.core.userdetails.User;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;import javax.servlet.FilterChain;import javax.servlet.ServletException;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.io.IOException;import java.util.*;import java.util.stream.Collectors;import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;@Slf4jpublic class CustomAuthenticationFilter extends UsernamePasswordAuthenticationFilter {    private final AuthenticationManager authentificationManager;    public CustomAuthenticationFilter(AuthenticationManager authentificationManager) {        this.authentificationManager = authentificationManager;    }    @Override    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {        String username = request.getParameter("username");        String password = request.getParameter("password");        log.info("Username is: {}", username);        log.info("Password is: {}", password);        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(username, password);        return  authentificationManager.authenticate(authenticationToken);    }    @Override    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authentication) throws IOException, ServletException {        Algorithm algorithm = Algorithm.HMAC256(JWTUTIL.SECRET);        UserImpl user1 = (UserImpl) authentication.getPrincipal();        String access_token = JWT.create()                .withSubject(user1.getUsername())                .withExpiresAt(new Date(System.currentTimeMillis() + JWTUTIL.EXPIRE_ACCESS_TOKEN))                .withIssuer(request.getRequestURL().toString())                .withClaim("roles", user1.getAuthorities().stream().map(GrantedAuthority::getAuthority).collect(Collectors.toList()))                .sign(algorithm);        String refresh_token = JWT.create()                .withSubject(user1.getUsername())                .withExpiresAt(new Date(System.currentTimeMillis() + JWTUTIL.EXPIRE_ACCESS_TOKEN))                .withIssuer(request.getRequestURL().toString())                .sign(algorithm);        Collection<String> roles = user1.getAuthorities().stream()                .map(item -> item.getAuthority())                .collect(Collectors.toList());        UserDto userDto = new UserDto();        userDto.setNom(user1.getNom());        userDto.setPrenom(user1.getPrenom());        userDto.setUsername(user1.getUsername());        userDto.setRoles(roles);        TokensDto tokensDto = new TokensDto();        tokensDto.setRefresh_token(refresh_token);        tokensDto.setAccess_token(access_token);        ResultDto resultDto = new ResultDto();        resultDto.setData(userDto);        resultDto.setToken(tokensDto);        response.setContentType(APPLICATION_JSON_VALUE);        new ObjectMapper().writeValue(response.getOutputStream(),resultDto);    }}